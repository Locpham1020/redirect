<!DOCTYPE html>
<html>
<head>
  <title>Chuyển hướng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    // Log cho debugging
    console.log("Redirect page loaded:", window.location.href);
    
    // Phân tích URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get('to') || '';
    const pid = urlParams.get('pid') || 'unknown';
    const pf = urlParams.get('pf') || 'unknown';
    
    console.log("Parameters:", { to: targetUrl, pid, pf });
    
    // URL của Apps Script
    const loggerUrl = 'https://script.google.com/macros/s/AKfycbzhXVKRdOVRFKeDzKMeXWlP5eZEPvJjwZEsrvfuNjG83SsHPcYnEM5hC59KzhQQuGA4VQ/exec';
    
    // Kiểm tra URL hợp lệ
    function isValidUrl(url) {
      try {
        return url && url.length > 5 && (
          url.startsWith('http://') || 
          url.startsWith('https://') || 
          url.startsWith('shopee://') ||
          url.startsWith('tiktok://')
        );
      } catch {
        return false;
      }
    }
    
    // Ghi log
    function sendLog() {
      try {
        const img = new Image();
        img.onload = function() { console.log("Log request sent successfully"); };
        img.onerror = function() { console.log("Error sending log request"); };
        img.src = `${loggerUrl}?product_id=${encodeURIComponent(pid)}&platform=${encodeURIComponent(pf)}&user_agent=${encodeURIComponent(navigator.userAgent)}&t=${new Date().getTime()}`;
      } catch (e) {
        console.error("Error during logging:", e);
      }
    }
    
    // Chuyển hướng khi người dùng click
    function redirectToTarget() {
      if (!isValidUrl(targetUrl)) {
        document.getElementById('status').textContent = "Lỗi: URL đích không hợp lệ";
        document.getElementById('error-detail').textContent = "URL nhận được: " + targetUrl;
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('redirect-info').style.display = 'none';
        return;
      }
      
      console.log("Redirecting to:", targetUrl);
      window.location.href = targetUrl;
    }
    
    // Quay lại trang trước
    function goBack() {
      window.history.back();
    }
    
    // Gọi khi trang đã tải xong
    window.onload = function() {
      // Gửi log
      sendLog();
      
      // Kiểm tra URL đích hợp lệ
      if (isValidUrl(targetUrl)) {
        try {
          let domain;
          if (targetUrl.startsWith('http')) {
            domain = new URL(targetUrl).hostname;
          } else {
            domain = targetUrl.split('://')[0] + " app";
          }
          document.getElementById('target-domain').textContent = domain;
          document.getElementById('target-url').textContent = targetUrl;
        } catch(e) {
          document.getElementById('target-domain').textContent = "app://";
          document.getElementById('target-url').textContent = targetUrl;
        }
      } else {
        document.getElementById('redirect-info').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-detail').textContent = "URL nhận được: " + targetUrl;
      }
    };
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f8f9fa;
      text-align: center;
    }
    .content {
      max-width: 90%;
      width: 500px;
      padding: 20px;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    .redirect-button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 12px 30px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    .back-button {
      background-color: #6c757d;
      border: none;
      color: white;
      padding: 12px 30px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    #error-message {
      color: red;
      display: none;
      margin: 20px 0;
    }
    #error-detail {
      font-size: 12px;
      word-break: break-all;
      color: #6c757d;
    }
    .domain-info {
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
    }
    .url-display {
      word-break: break-all;
      font-size: 12px;
      color: #6c757d;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="content">
    <div class="loader"></div>
    <h2 id="status">Đang chuẩn bị chuyển hướng...</h2>
    
    <div id="redirect-info">
      <p>Bạn sắp được chuyển hướng đến:</p>
      <div class="domain-info">
        <strong id="target-domain">domain.com</strong>
      </div>
      <p class="url-display" id="target-url">https://example.com</p>
      <div class="buttons">
        <button class="back-button" onclick="goBack()">Quay lại</button>
        <button class="redirect-button" id="target-btn" onclick="redirectToTarget()">Tiếp tục</button>
      </div>
    </div>
    
    <div id="error-message">
      <p>Không tìm thấy URL đích hợp lệ. Vui lòng quay lại và thử lại.</p>
      <p id="error-detail"></p>
      <button class="back-button" onclick="goBack()">Quay lại</button>
    </div>
  </div>
</body>
</html>
